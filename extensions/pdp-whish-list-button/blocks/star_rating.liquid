{% style %}
.heart-btn-wrapper {
  text-align: center;
}

.heart-btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  padding: 12px 22px;
  font-size: {{ block.settings.font_size }}px;
  cursor: pointer;
  border-radius: {{ block.settings.border_radius }}px;
  transition: all 0.2s ease;
  width: 100%;
  box-sizing: border-box;
  max-width: 44rem;
  border: 2px solid {{ block.settings.border_color }};
  color: {{ block.settings.text_color }};
  background: transparent;
}

.heart-btn svg {
  fill: {{ block.settings.heart_color }};
}

.heart-btn.is-active {
  background: {{ block.settings.fill_bg_color }};
  border-color: {{ block.settings.fill_bg_color }};
  color: {{ block.settings.fill_text_color }};
}

.heart-btn.is-active svg {
  fill: {{ block.settings.fill_heart_color }};
}

.heart-subtext {
  margin-top: 6px;
  font-size: 12px;
  color: {{ block.settings.sub_text_color }};
}

{% endstyle %}

<div class="heart-btn-wrapper">
  <button type="button"
     class="heart-btn"
     :class="wishlisted ? 'is-active' : ''"
     x-data="wishlist"
     @click="addToWishlist">

    <svg width="18" height="18" viewBox="0 0 24 24">
      <path d="M12 21s-7.5-4.35-10-9c-2-3.7.5-8 4.5-8 2.2 0 3.5 1.4 3.5 1.4S11.3 4 13.5 4c4 0 6.5 4.3 4.5 8-2.5 4.65-10 9-10 9z"/>
    </svg>

    {{ block.settings.button_text }}
  </button>

  {% if block.settings.sub_text != blank %}
    <div class="heart-subtext">
      {{ block.settings.sub_text }}
    </div>
  {% endif %}
</div>
 <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
 <script>
document.addEventListener('alpine:init', () => {
  Alpine.data('wishlist', () => ({
    wishlisted: false,
    wishlistItemId: null,
    customerId: '{{ customer.id | default: "" }}',
    productId: '{{ product.id }}',
    variantId: '{{ product.selected_or_first_available_variant.id }}',
    // apiBaseUrl: (typeof window !== 'undefined' && window.API_BASE_URL) ? window.API_BASE_URL : window.location.origin,
    apiBaseUrl: 'https://leandro-tinklier-camie.ngrok-free.dev',

    init() {
      // On load, hydrate state from API (logged-in) or localStorage (guest)
      if (this.customerId) {
        console.log("this is api url---11",this.apiBaseUrl);
        fetch(`${this.apiBaseUrl}/api/wishlist?customerId=${encodeURIComponent(this.customerId)}`)
          .then(res => res.json())
          .then(data => {
            const found = (data.wishlist || []).find(
              (item) => item.productId === this.productId && item.variantId === this.variantId
            );
            if (found) {
              this.wishlisted = true;
              this.wishlistItemId = found.id;
            }
          })
          .catch(() => {});
      } else {
        const guestWishlist = JSON.parse(localStorage.getItem('guestWishlist') || '[]');
        const found = guestWishlist.find(
          (item) => item.productId === this.productId && item.variantId === this.variantId
        );
        if (found) {
          this.wishlisted = true;
        }
      }
    },

    addToWishlist() {
      if (this.customerId) {
        if (!this.wishlisted) {
          console.log("this is api url---22",this.apiBaseUrl);
          fetch(`${this.apiBaseUrl}/api/wishlist/add`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json' 
            },
            body: JSON.stringify({
              customerId: this.customerId,
              productId: this.productId,
              variantId: this.variantId
            })
          })
            .then(res => res.json())
            .then(res => {
              if (res.success) {
                this.wishlisted = true;
                this.wishlistItemId = res.wishlistItemId || null;
              }
            });
        } else if (this.wishlistItemId) {
          fetch(`${this.apiBaseUrl}/api/wishlist/remove`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              wishlistItemId: this.wishlistItemId
            })
          })
            .then(res => res.json())
            .then(res => {
              if (res.success) {
                this.wishlisted = false;
                this.wishlistItemId = null;
              }
            });
        }
      } else {
        let guestWishlist = JSON.parse(localStorage.getItem('guestWishlist') || '[]');
        console.log("this is ",guestWishlist)
        const index = guestWishlist.findIndex(
          item => item.productId === this.productId && item.variantId === this.variantId
        );

        if (!this.wishlisted) {
          if (index === -1) {
            guestWishlist.push({ productId: this.productId, variantId: this.variantId });
            localStorage.setItem('guestWishlist', JSON.stringify(guestWishlist));
            this.wishlisted = true;
          }
        } else {
          if (index !== -1) {
            guestWishlist.splice(index, 1);
            localStorage.setItem('guestWishlist', JSON.stringify(guestWishlist));
            this.wishlisted = false;
          }
        }
      }
    }
  }))
});
</script>

{% schema %}
{
  "name": "Heart Button",
  "target": "section",
  "settings": [
    {
      "type": "select",
      "id": "button_style",
      "label": "Button Style",
      "options": [
        { "value": "outline", "label": "Outline" },
        { "value": "fill", "label": "Fill" }
      ],
      "default": "outline"
    },
    {
      "type": "text",
      "id": "button_text",
      "label": "Button Text",
      "default": "Add to Wishlist"
    },
    {
      "type": "url",
      "id": "button_link",
      "label": "Button Link"
    },

    { "type": "color", "id": "border_color", "label": "Outline Border Color", "default": "#000000" },
    { "type": "color", "id": "text_color", "label": "Outline Text Color", "default": "#000000" },
    { "type": "color", "id": "heart_color", "label": "Outline Heart Color", "default": "#000000" },

    { "type": "color", "id": "hover_bg_color", "label": "Outline Hover Background", "default": "#000000" },
    { "type": "color", "id": "hover_border_color", "label": "Outline Hover Border", "default": "#000000" },
    { "type": "color", "id": "hover_text_color", "label": "Outline Hover Text", "default": "#ffffff" },
    { "type": "color", "id": "hover_heart_color", "label": "Outline Hover Heart", "default": "#ffffff" },

    { "type": "color", "id": "fill_bg_color", "label": "Fill Background", "default": "#000000" },
    { "type": "color", "id": "fill_text_color", "label": "Fill Text Color", "default": "#ffffff" },
    { "type": "color", "id": "fill_heart_color", "label": "Fill Heart Color", "default": "#ffffff" },

    {
      "type": "range",
      "id": "border_radius",
      "label": "Border Radius",
      "min": 0,
      "max": 40,
      "default": 6
    },
    {
      "type": "range",
      "id": "font_size",
      "label": "Font Size",
      "min": 12,
      "max": 24,
      "default": 14
    },

    {
      "type": "text",
      "id": "sub_text",
      "label": "Sub Text (below button)",
      "default": "Save for later"
    },
    {
      "type": "color",
      "id": "sub_text_color",
      "label": "Sub Text Color",
      "default": "#666666"
    }
  ]
}
{% endschema %}
